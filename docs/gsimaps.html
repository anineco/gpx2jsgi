<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<meta http-equiv="Content-Script-Type" content="text/javascript" />
<meta name="robots" content="none" />
<title>ルート地図</title>
<style type="text/css">
html,body { overflow:hidden;height:100%; }
*+html #map_canvas { height:expression(document.documentElement.clientHeight-30+'px'); } /* IE7 */
* html #map_canvas { height:expression(document.body.clientHeight-30+'px'); } /* IE6 */
@media print {
body { width:259mm;height:172mm; } /* A4 */
#map_canvas { width:100%;height:100%; }
#map_panel,.olControlZoom,.olControlLayerSwitcher { display:none; }
.olControlAttribution { position:absolute;right:3px;bottom:5px;background-color:#000; }
.olControlScaleLine { position:absolute;left:10px;bottom:15px; }
}
</style>
<script type="text/javascript" src="http://map.jpn.org/sys/OpenLayers-2.13.1/OpenLayers.gsimaps.js"></script>
<script type="text/javascript" src="js/centercross.js"></script>
<script type="text/javascript">//<![CDATA[
window.onload = function() {
	var param = {};
	var ma = location.search.substr(1).split('&');
	for (var i = 0; i < ma.length; i++) {
		var s = ma[i].split('=');
		param[s[0]] = decodeURIComponent(s[1]);
	}

	var proj_3857 = new OpenLayers.Projection('EPSG:3857');
	var proj_4326 =  new OpenLayers.Projection('EPSG:4326');
	var map = new OpenLayers.Map({
		div: 'map_canvas',
		projection: proj_3857,
		displayProjection: proj_4326,
		size: new OpenLayers.Size(640, 480)
	});
	var std = new OpenLayers.Layer.XYZ('標準地図', 'http://cyberjapandata.gsi.go.jp/xyz/std/${z}/${x}/${y}.png', {
		attribution: '<a href="http://portal.cyberjapan.jp/help/termsofuse.html" target="_blank">国土地理院</a>',
		maxZoomLevel: 18
	});
	var pale = new OpenLayers.Layer.XYZ('淡色地図', 'http://cyberjapandata.gsi.go.jp/xyz/pale/${z}/${x}/${y}.png', {
		attribution: '<a href="http://portal.cyberjapan.jp/help/termsofuse.html" target="_blank">国土地理院</a>',
		maxZoomLevel: 18
	});
	map.addLayers([std, pale]);
	if (!map.getCenter()) {
		map.setCenter(new OpenLayers.LonLat(param.lon, param.lat).transform(proj_4326, proj_3857), param.zoom);
	}

	map.addControl(new OpenLayers.Control.ScaleLine());
	map.addControl(new OpenLayers.Control.LayerSwitcher());

	var kmlLayer = new OpenLayers.Layer.Vector('GPSデータ', {
		projection: proj_4326,
		strategies: [new OpenLayers.Strategy.Fixed()],
		protocol: new OpenLayers.Protocol.HTTP({
			url: param.url,
			format: new OpenLayers.Format.KML({
				extractStyles: true,
				extractAttributes: true,
				maxDepth: 2
			})
		})
	});
	map.addLayer(kmlLayer);

	kmlLayer.events.on({
		featureselected: onFeatureSelect,
		featureunselected: onFeatureUnselect
	});
	selectControl = new OpenLayers.Control.SelectFeature(kmlLayer);
	map.addControl(selectControl);
	selectControl.activate();

	function onFeatureSelect(event) {
		var feature = event.feature;
		var content = '<h2>' + feature.attributes.name + '</h2>';
		if (feature.attributes.description) {
			content += feature.attributes.description;
		}

		var popup = new OpenLayers.Popup.FramedCloud('chicken',
			feature.geometry.getBounds().getCenterLonLat(),
			new OpenLayers.Size(100,100),
			content, null, true, onPopupClose
		);
		feature.popup = popup;
		map.addPopup(popup);
	}

	function onFeatureUnselect(event) {
		var popup = event.feature.popup;
		if (popup) {
			map.removePopup(popup);
			popup.destroy();
			delete popup;
		}
	}

	function onPopupClose(event) {
		selectControl.unselectAll();
	}

	var sel = document.getElementById('zoom');
	for (var i = 18; i >= 0; i--) {
		var opt = document.createElement('option');
		var txt = document.createTextNode(i);
		opt.setAttribute('value', i);
		opt.appendChild(txt);
		sel.appendChild(opt);
	}
	sel.onchange = function() {
		map.zoomTo(this.options[this.selectedIndex].value);
	};

	map.events.register('zoomend', map, function() {
		var i = sel.selectedIndex;
		i = i - (map.getZoom() - sel.options[i].value);
		if (i >= 0 && i < sel.length) {
			sel.selectedIndex = i;
		}
	});
	map.events.triggerEvent('zoomend');

	document.getElementById('center').onclick = function() {
		var center = map.getCenter();
		center.transform(proj_3857, proj_4326);
		var lat = center.lat.toFixed(6);
		var lon = center.lon.toFixed(6);
		alert('緯度=' + lat + '\n経度=' + lon);
	};

	var crs = null;
	document.getElementById('cross').onchange = function() {
		if (this.checked) {
			crs = new OpenLayers.Control.CenterCross({
				crosslength: 32,
				bold: 1
			})
			map.addControl(crs);
		} else if (crs) {
			map.removeControl(crs);
			crs.destroy();
		}
	}
//	document.getElementById('cross').onchange();
};
//]]></script>
</head>
<body style="margin:0;">
<div id="map_canvas" style="width:100%;position:absolute;top:0;bottom:30px;"></div>
<div id="map_panel" style="width:100%;height:30px;position:absolute;bottom:0;background-color:#ccc;">
<form action="#" style="margin:0;padding:3px 5px 0px 5px;font-family:sans-serif;font-size:small;">
<div style="float:left;">ズーム
<select id="zoom"></select></div>
<div style="float:left;margin-left:5px;"><input id="cross" type="checkbox" />中心点</div>
<div style="float:left;margin-left:5px;"><input id="center" type="button" value="中心座標" /></div>
<div style="float:left;margin-left:5px;"><input type="button" value="印刷" onclick="top.print()" /></div>
<div style="float:right;"><input type="button" value="閉じる" onclick="top.close()" /></div>
</form>
</div>
</body>
</html>
